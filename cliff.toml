# git-cliff configuration for gitmoji commits
# https://git-cliff.org/docs/configuration

[changelog]
# Template for the changelog header
header = """
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

"""

# Template for the changelog body
# https://keats.github.io/tera/docs/#introduction
body = """
{% if version %}\
## [{{ version | trim_start_matches(pat="v") }}] - {{ timestamp | date(format="%Y-%m-%d") }}
{% else %}\
## [Unreleased]
{% endif %}\
{% for group, commits in commits | group_by(attribute="group") %}\
{% set_global has_entries = false %}\
{% for commit in commits %}\
{% if commit.message is containing("(#") %}\
{% set_global has_entries = true %}\
{% endif %}\
{% endfor %}\
{% if has_entries %}

### {{ group }}
{% for commit in commits %}\
{% if commit.message is containing("(#") %}
- {% if commit.scope %}*({{ commit.scope }})* {% endif %}{{ commit.message | upper_first }}\
{% endif %}\
{% endfor %}
{% endif %}\
{% endfor %}

"""

# Template for the changelog footer
footer = """
<!-- Links -->
{% for release in releases -%}
{% if release.version -%}
{% if release.previous.version -%}
[{{ release.version | trim_start_matches(pat="v") }}]: https://github.com/135yshr/devcycle-cli/compare/{{ release.previous.version }}...{{ release.version }}
{% else -%}
[{{ release.version | trim_start_matches(pat="v") }}]: https://github.com/135yshr/devcycle-cli/releases/tag/{{ release.version }}
{% endif -%}
{% else -%}
[Unreleased]: https://github.com/135yshr/devcycle-cli/compare/{{ release.previous.version }}...HEAD
{% endif -%}
{% endfor %}
"""

# Remove leading/trailing whitespace from the rendered template
trim = true

# Postprocessors for the changelog body
postprocessors = [
  # Remove gitmoji from commit messages (only in list items, not headers)
  { pattern = '^- [\U0001F300-\U0001F9FF\U00002600-\U000027BF]\s*', replace = "- " },
  # Remove â¬†ï¸ emoji specifically (common in deps commits)
  { pattern = 'â¬†ï¸\s*', replace = "" },
  # Remove prefix words (Feat:, Fix:, Docs:, etc.) from messages
  { pattern = '(?i)(Feat|Fix|Docs|Ci|Test|Refactor|Perf|Build|Chore|Style):\s*', replace = "" },
  # Remove "Phase N: " or "Phase N " prefix from messages
  { pattern = 'Phase \d+:?\s+', replace = "" },
  # Remove "chore: " and "deps: " prefixes
  { pattern = '(?i)(chore|deps):\s*', replace = "" },
  # Reduce multiple consecutive empty lines to single empty line
  { pattern = '\n{3,}', replace = "\n\n" },
]

[git]
# Parse conventional commits
conventional_commits = false
# Filter commits to include
filter_unconventional = false
# Process each line of a commit as an individual commit
split_commits = false
# Regex for preprocessing the commit messages
commit_preprocessors = [
  # Remove gitmoji prefix for grouping but keep original message
  { pattern = '^[\U0001F300-\U0001F9FF\U00002600-\U000027BF]\s*', replace = "" },
  # Keep only the first line of commit messages (remove body)
  { pattern = '\n[\s\S]*', replace = "" },
]

# Regex for parsing and grouping commits by gitmoji
commit_parsers = [
  # Features
  { message = "^âœ¨", group = "â›°ï¸ Features" },
  { message = "^feat", group = "â›°ï¸ Features" },

  # Bug fixes
  { message = "^ğŸ›", group = "ğŸ› Bug Fixes" },
  { message = "^ğŸ©¹", group = "ğŸ› Bug Fixes" },
  { message = "^fix", group = "ğŸ› Bug Fixes" },

  # Documentation
  { message = "^ğŸ“", group = "ğŸ“š Documentation" },
  { message = "^docs", group = "ğŸ“š Documentation" },

  # Performance
  { message = "^âš¡", group = "âš¡ Performance" },
  { message = "^perf", group = "âš¡ Performance" },

  # Refactoring
  { message = "^â™»ï¸", group = "â™»ï¸ Refactoring" },
  { message = "^ğŸ¨", group = "â™»ï¸ Refactoring" },
  { message = "^refactor", group = "â™»ï¸ Refactoring" },

  # Testing
  { message = "^âœ…", group = "ğŸ§ª Testing" },
  { message = "^ğŸ§ª", group = "ğŸ§ª Testing" },
  { message = "^test", group = "ğŸ§ª Testing" },

  # Build/CI
  { message = "^ğŸ‘·", group = "ğŸ”§ Build" },
  { message = "^ğŸ”§", group = "ğŸ”§ Build" },
  { message = "^ğŸ“¦", group = "ğŸ”§ Build" },
  { message = "^ci", group = "ğŸ”§ Build" },
  { message = "^build", group = "ğŸ”§ Build" },

  # Security
  { message = "^ğŸ”’", group = "ğŸ”’ Security" },
  { message = "^ğŸ”", group = "ğŸ”’ Security" },

  # Dependencies
  { message = "^â¬†ï¸", group = "ğŸ“¦ Dependencies" },
  { message = "^â¬‡ï¸", group = "ğŸ“¦ Dependencies" },
  { message = "^ğŸ“Œ", group = "ğŸ“¦ Dependencies" },

  # Deprecation
  { message = "^ğŸ—‘ï¸", group = "ğŸ—‘ï¸ Deprecated" },

  # Removal
  { message = "^ğŸ”¥", group = "ğŸ”¥ Removed" },
  { message = "^â–", group = "ğŸ”¥ Removed" },

  # Breaking changes
  { message = "^ğŸ’¥", group = "ğŸ’¥ Breaking Changes" },

  # Initial commit
  { message = "^ğŸ‰", group = "â›°ï¸ Features" },

  # Release
  { message = "^ğŸ”–", skip = true },

  # Merge commits
  { message = "^Merge", skip = true },

  # Other - catch all
  { message = ".*", group = "ğŸ”€ Other" },
]

# Protect breaking changes from being skipped
protect_breaking_commits = false

# Filter out commits by patterns
filter_commits = true

# Tag pattern for releases
tag_pattern = "v[0-9].*"

# Sort commits by newest first
sort_commits = "newest"

# Limit the number of commits included in the changelog
# limit_commits = 42
